const chrome={storage:{local:{get:jest.fn(),set:jest.fn()}},action:{setBadgeText:jest.fn(),setBadgeBackgroundColor:jest.fn()}};const knownTrackers={"google-analytics.com":{name:"Google Analytics",category:"Analytics"},"doubleclick.net":{name:"DoubleClick",category:"Advertising"}};let trackingData={};let setPromises=[];function extractDomain(url){try{const urlObj=new URL(url);return urlObj.hostname;}catch(e){return url;}}function isKnownTracker(domain){if(knownTrackers[domain])return knownTrackers[domain];for(const trackerDomain in knownTrackers){if(domain.endsWith(`.${trackerDomain}`)||domain===trackerDomain){return knownTrackers[trackerDomain];}}return null;}function updateTrackerHistory(tabId){if(trackingData[tabId]&&trackingData[tabId].pageDomain){const domain=trackingData[tabId].pageDomain;let newTotalTrackers=0;let newTrackers={};for(const trackerDomain in trackingData[tabId].trackers){const tracker=trackingData[tabId].trackers[trackerDomain];newTrackers[trackerDomain]={...tracker};newTotalTrackers+=tracker.count;}chrome.storage.local.get('trackerHistory',(data)=>{let updatedTrackerHistory={...(data.trackerHistory||{})};if(newTotalTrackers===0&&Object.keys(newTrackers).length===0){if(updatedTrackerHistory[domain]){delete updatedTrackerHistory[domain];}}else{updatedTrackerHistory[domain]={totalTrackers:newTotalTrackers,trackers:newTrackers};}chrome.storage.local.set({trackerHistory:updatedTrackerHistory});});}}function processRequest(details){const tabId=details.tabId;const targetDomain=extractDomain(details.url);const trackerInfo=isKnownTracker(targetDomain);if(!trackerInfo||tabId<0)return;if(!trackingData[tabId]){trackingData[tabId]={pageUrl:details.initiator||details.url,pageDomain:extractDomain(details.initiator||details.url),trackers:{}};}if(!trackingData[tabId].trackers[targetDomain]){trackingData[tabId].trackers[targetDomain]={name:trackerInfo.name,category:trackerInfo.category,count:0,urls:[]};}trackingData[tabId].trackers[targetDomain].count++;if(!trackingData[tabId].trackers[targetDomain].urls.includes(details.url)&&trackingData[tabId].trackers[targetDomain].urls.length<5){trackingData[tabId].trackers[targetDomain].urls.push(details.url);}updateTrackerHistory(tabId);}describe('Tracker History Snapshot Regression',()=>{beforeEach(()=>{trackingData={};let mockStorage={trackerHistory:{}};chrome.storage.local.get.mockImplementation((keys,callback)=>{if(keys==='trackerHistory'){callback({trackerHistory:mockStorage.trackerHistory});}else{callback({});}});setPromises=[];chrome.storage.local.set.mockImplementation((data)=>{const p=new Promise(resolve=>{if(data.trackerHistory)mockStorage.trackerHistory=data.trackerHistory;resolve();});setPromises.push(p);return p;});});test('aggregated trackerHistory matches snapshot',async()=>{processRequest({tabId:1,initiator:"https://site-a.com",url:"https://www.google-analytics.com/analytics.js"});processRequest({tabId:1,initiator:"https://site-a.com",url:"https://doubleclick.net/ad.js"});processRequest({tabId:2,initiator:"https://site-b.com",url:"https://doubleclick.net/ad.js"});processRequest({tabId:2,initiator:"https://site-b.com",url:"https://www.google-analytics.com/collect"});await Promise.all(setPromises);let history;await new Promise(resolve=>{chrome.storage.local.get('trackerHistory',(result)=>{history=result.trackerHistory;resolve();});});expect(history).toMatchSnapshot();});});